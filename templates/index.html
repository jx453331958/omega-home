<!DOCTYPE html>
<html lang="zh-CN" x-data="portal()" x-init="init()" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="settings.title || 'Omega Home'">Omega Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; }
        .fade-delay-1 { animation-delay: 0.1s; }
        .fade-delay-2 { animation-delay: 0.2s; }
        .fade-delay-3 { animation-delay: 0.3s; }
    </style>
</head>
<body class="min-h-screen transition-colors duration-500" :class="themeClass">
    <!-- Top ambient glow -->
    <div class="fixed top-0 left-0 right-0 h-[600px] pointer-events-none -z-10"
        style="background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(120,119,198,0.15), transparent)"></div>

    <!-- Background overlay for custom image -->
    <div x-show="settings.background_image" class="fixed inset-0 bg-cover bg-center -z-10" :style="settings.background_image ? 'background-image: url(' + settings.background_image + ')' : ''"></div>

    <div class="min-h-screen" :class="settings.background_image ? 'bg-black/40' : ''">
        <!-- Header -->
        <header class="pt-8 pb-4 px-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <template x-if="settings.logo">
                        <img :src="settings.logo" class="w-10 h-10 rounded-lg" alt="logo">
                    </template>
                    <h1 class="text-xl font-bold text-white" x-text="settings.title || 'Omega Home'"></h1>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Clock -->
                    <div x-show="settings.clock_enabled === 'true'" class="text-white/40 text-sm font-mono tabular-nums" x-text="clock"></div>
                    <!-- Theme toggle -->
                    <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode)"
                        class="p-2 rounded-lg bg-white/5 border border-white/8 text-white/50 hover:bg-white/10 hover:text-white/80 transition-all duration-200">
                        <svg x-show="!darkMode" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 006.002-2.082z" />
                        </svg>
                        <svg x-show="darkMode" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Greeting (minimal) -->
        <div x-show="settings.greeting_enabled === 'true'" class="max-w-6xl mx-auto px-4 pb-2">
            <p class="text-white/30 text-sm" x-text="greeting"></p>
        </div>

        <!-- Search bar -->
        <div x-show="settings.search_enabled === 'true'" class="max-w-xl mx-auto px-4 pb-6">
            <div class="bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 flex items-center gap-3 focus-within:border-white/20 focus-within:ring-1 focus-within:ring-white/10 transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white/30 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input type="text" x-model="search" placeholder="搜索服务..."
                    class="w-full bg-transparent text-white/90 placeholder-white/30 outline-none text-sm">
                <button x-show="search" @click="search = ''" class="text-white/30 hover:text-white/60 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Bookmarks bar -->
        <div x-show="bookmarks.length > 0" class="max-w-6xl mx-auto px-4 pb-6">
            <div class="flex flex-wrap gap-2">
                <template x-for="b in bookmarks" :key="b.id">
                    <a :href="b.url" target="_blank"
                        class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-white/5 border border-white/[0.08] text-white/50 text-xs hover:bg-white/10 hover:text-white/70 transition-all duration-200">
                        <span x-text="b.icon || ''" class="text-xs" x-show="b.icon"></span>
                        <span x-text="b.name"></span>
                    </a>
                </template>
            </div>
        </div>

        <!-- Groups -->
        <main class="max-w-6xl mx-auto px-4 pb-12 space-y-8">
            <template x-for="(group, gi) in filteredGroups" :key="group.id">
                <section class="fade-in-up" :class="'fade-delay-' + (gi % 4)">
                    <h2 class="text-xs uppercase tracking-wider text-white/40 font-medium mb-4" x-text="group.name"></h2>
                    <div class="grid gap-3"
                        :class="{
                            'grid-cols-1': true,
                            'sm:grid-cols-2': group.columns >= 2,
                            'md:grid-cols-3': group.columns >= 3,
                            'lg:grid-cols-4': group.columns >= 4
                        }">
                        <template x-for="svc in group.services" :key="svc.id">
                            <a :href="svc.url" :target="svc.target || '_blank'"
                                class="group block bg-white/[0.03] border border-white/[0.06] rounded-xl p-5 shadow-[0_0_0_1px_rgba(255,255,255,0.06)] hover:border-white/[0.15] hover:bg-white/[0.05] transition-all duration-200 cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <template x-if="svc.icon && svc.icon.startsWith('http')">
                                        <img :src="svc.icon" class="w-10 h-10 rounded-lg flex-shrink-0" alt="">
                                    </template>
                                    <template x-if="!svc.icon || !svc.icon.startsWith('http')">
                                        <div class="w-10 h-10 rounded-lg bg-white/[0.06] flex items-center justify-center text-lg flex-shrink-0" x-text="svc.icon || '·'"></div>
                                    </template>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <span class="font-medium text-white/90 text-sm" x-text="svc.name"></span>
                                            <template x-if="svc.status_check && status[svc.id]">
                                                <span class="w-2 h-2 rounded-full flex-shrink-0"
                                                    :class="status[svc.id].online ? 'bg-green-500 shadow-[0_0_6px_rgba(34,197,94,0.4)]' : 'bg-red-500'"></span>
                                            </template>
                                        </div>
                                        <p class="text-white/40 text-sm truncate" x-text="svc.description"></p>
                                    </div>
                                </div>
                            </a>
                        </template>
                    </div>
                </section>
            </template>

            <div x-show="filteredGroups.length === 0 && !loading" class="text-center py-20">
                <p class="text-white/30 text-sm" x-text="search ? '没有找到匹配的服务' : '暂无服务，请在管理后台添加'"></p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="py-6 px-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <span class="text-white/20 text-xs" x-text="settings.footer_text || 'Powered by Omega Home'"></span>
                <a href="/admin" class="text-white/20 text-xs hover:text-white/40 transition-colors duration-200">管理</a>
            </div>
        </footer>
    </div>

    <script>
    function portal() {
        return {
            groups: [],
            bookmarks: [],
            settings: {},
            status: {},
            search: '',
            clock: '',
            darkMode: localStorage.getItem('darkMode') === 'true' || window.matchMedia('(prefers-color-scheme: dark)').matches,
            loading: true,

            get greeting() {
                const h = new Date().getHours();
                if (h < 6) return '夜深了，注意休息';
                if (h < 12) return '早上好';
                if (h < 14) return '中午好';
                if (h < 18) return '下午好';
                return '晚上好';
            },

            get themeClass() {
                const themes = {
                    'midnight': 'bg-[#0a0a0a]',
                    'deep-blue': 'bg-gradient-to-br from-[#0a1628] to-[#0d1117]',
                    'charcoal': 'bg-gradient-to-br from-[#18181b] to-[#09090b]',
                };
                return themes[this.settings.theme] || themes['midnight'];
            },

            get filteredGroups() {
                if (!this.search) return this.groups;
                const q = this.search.toLowerCase();
                return this.groups.map(g => ({
                    ...g,
                    services: g.services.filter(s =>
                        s.name.toLowerCase().includes(q) ||
                        (s.description && s.description.toLowerCase().includes(q))
                    )
                })).filter(g => g.services.length > 0);
            },

            async init() {
                this.updateClock();
                setInterval(() => this.updateClock(), 1000);

                try {
                    const res = await fetch('/api/config');
                    const data = await res.json();
                    this.groups = data.groups || [];
                    this.settings = data.settings || {};
                    this.bookmarks = data.bookmarks || [];
                } catch(e) {
                    console.error('Failed to load config:', e);
                }
                this.loading = false;

                this.fetchStatus();
                setInterval(() => this.fetchStatus(), 30000);
            },

            async fetchStatus() {
                try {
                    const res = await fetch('/api/status');
                    this.status = await res.json();
                } catch(e) {}
            },

            updateClock() {
                const now = new Date();
                this.clock = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
        };
    }
    </script>
</body>
</html>
